<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>美股財報一致性分析器 Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0e14;--card:#121826;--muted:#94a3b8;--text:#e2e8f0;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',sans-serif;color:var(--text)}
.wrap{max-width:1200px;margin:40px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h1{font-size:28px;margin:0 0 12px}
label{display:block;margin:8px 0 6px;color:var(--muted)}
input,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0f172a;color:var(--text);font-size:16px}
button{cursor:pointer;background:linear-gradient(135deg,#2563eb,#06b6d4);border:none}
button:disabled{opacity:.6;cursor:not-allowed}
.row{display:grid;grid-template-columns:1fr 1fr 150px;gap:12px}
.muted{color:var(--muted)}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
.kpi{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:12px}
.kpi h3{margin:0;font-size:13px;color:var(--muted)}
.kpi p{margin:6px 0 0;font-size:20px;font-weight:700}
pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px;color:#cbd5e1}
canvas{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px}
.status-pill{margin-top:14px;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:#0f172a;border:1px solid #1f2937;font-size:14px;color:var(--muted)}
.status-pill::before{content:'';width:10px;height:10px;border-radius:50%;background:var(--muted)}
.status-pill[data-state="running"]{color:#bfdbfe;border-color:#2563eb}
.status-pill[data-state="running"]::before{background:#60a5fa;animation:pulse 1s ease-in-out infinite}
.status-pill[data-state="done"]{color:var(--ok);border-color:var(--ok)}
.status-pill[data-state="done"]::before{background:var(--ok);animation:none}
.status-pill[data-state="error"]{color:var(--bad);border-color:var(--bad)}
.status-pill[data-state="error"]::before{background:var(--bad)}
.status-pill[data-state="idle"]::before{background:var(--muted)}
.timeline{display:grid;gap:10px}
.ti{border:1px solid #1f2937;border-radius:12px;padding:12px;background:#0f172a}
.ti h4{margin:0 0 8px}
.ti .meta{font-size:13px;color:var(--muted)}
.summary{line-height:1.7}
@media(max-width:1000px){.grid,.row,.kpis{grid-template-columns:1fr}}
@keyframes pulse{0%{transform:scale(.7);opacity:.7}50%{transform:scale(1.3);opacity:1}100%{transform:scale(.7);opacity:.7}}
</style>
</head>
<body>
<div class="wrap">
  <h1>美股財報一致性分析器 Pro</h1>
  <p class="muted">輸入股票代號與日期（YYYY-MM-DD）。系統回溯四季 10-Q/10-K，合併分析師資料，輸出五大指標與投資建議。</p>
  <div class="card">
    <div class="row">
      <div><label>Ticker</label><input id="t" value="NVDA" placeholder="NVDA"/></div>
      <div><label>Date</label><input id="d" value="2025-11-08" placeholder="YYYY-MM-DD"/></div>
      <div style="align-self:end"><button id="go">分析</button></div>
      <div style="grid-column:1 / -1">
        <div id="status" class="status-pill" data-state="idle">待命中，請輸入條件後開始分析。</div>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi"><h3>現價</h3><p id="px">-</p></div>
      <div class="kpi"><h3>均目標價</h3><p id="ptMean">-</p></div>
      <div class="kpi"><h3>目標區間</h3><p id="ptRange">-</p></div>
      <div class="kpi"><h3>建議</h3><p id="rating">-</p></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">財報時間線與重點摘要</h3>
    <div id="timeline" class="timeline"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">ChatGPT 總結與結論</h3>
    <div id="consensus" class="summary muted">尚無資料</div>
    <div id="decision" class="summary" style="margin-top:8px"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">詳細 JSON（除錯用）</h3>
    <pre id="out">尚未查詢</pre>
  </div>
</div>

<script>
function clamp(x){ return Math.max(0, Math.min(1, x)); }
function n(x, d=2){ const v=Number(x); return Number.isFinite(v)? v.toFixed(d):'-'; }
function toNum(x){ const v=Number(x); return Number.isFinite(v)? v:null; }

function ensureTargets(pt, current){
  let hi = toNum(pt?.targetHigh), lo = toNum(pt?.targetLow), mean = toNum(pt?.targetMean ?? pt?.targetMedian);
  const cur = toNum(current);
  if(mean!=null){
    if(hi==null) hi = mean * 1.15;
    if(lo==null) lo = mean * 0.85;
  }
  if(hi!=null && lo==null) lo = hi/1.2;
  if(lo!=null && hi==null) hi = lo*1.2;
  if(cur!=null){
    if(hi!=null && cur>hi) hi = cur*1.05;
    if(lo!=null && cur<lo) lo = cur*0.95;
  }
  return {hi, lo, mean, cur};
}

function setKPIs(quote, pt, decision){
  const last = toNum(quote?.c);
  const targets = ensureTargets(pt, last);
  document.getElementById('px').textContent = last? ('$'+last.toFixed(2)) : '-';
  document.getElementById('ptMean').textContent = targets.mean? ('$'+targets.mean.toFixed(2)) : '-';
  document.getElementById('ptRange').textContent = (targets.lo||targets.hi)
      ? [targets.lo?('$'+targets.lo.toFixed(0)):'-', targets.hi?('$'+targets.hi.toFixed(0)):'-'].join(' ~ ')
      : '-';
  document.getElementById('rating').textContent = decision || '-';
}

function renderTimeline(perFiling){
  const box = document.getElementById('timeline');
  box.innerHTML='';
  (perFiling||[]).forEach((f,i)=>{
    const exp = f.explanation || '（模型目前未提供詳細解釋）';
    const html = `
      <div class="ti">
        <h4>${f.form || 'Filing'} · <span class="meta">${f.filingDate || ''}</span></h4>
        <div class="meta">報告期間：${f.reportDate || '-'}</div>
        <div class="summary" style="margin-top:6px">${exp}</div>
      </div>
    `;
    box.insertAdjacentHTML('beforeend', html);
  });
}

function renderConclusion(analysis){
  const cons = analysis?.consensus_view?.summary || '（尚無共識摘要）';
  const act = analysis?.action || {};
  const dec = (act.rating? `<b>${act.rating}</b>`:'-') +
              (act.target_price? ` · 目標價 $${n(act.target_price,0)}`:'') +
              (act.stop_loss? ` · 止損 $${n(act.stop_loss,0)}`:'');
  document.getElementById('consensus').innerHTML = cons;
  document.getElementById('decision').innerHTML = dec + (act.rationale? `<div class="muted" style="margin-top:6px">${act.rationale}</div>`:'');
}

const statusEl = document.getElementById('status');
function setStatus(text, state='idle'){
  statusEl.textContent = text;
  statusEl.setAttribute('data-state', state);
}

async function analyze(){
  const ticker = document.getElementById('t').value.trim().toUpperCase();
  const date   = document.getElementById('d').value.trim();
  if(!ticker || !date){
    setStatus('請先輸入 Ticker 與 Date。', 'error');
    return;
  }

  const btn = document.getElementById('go');
  const prevLabel = btn.textContent;
  btn.disabled = true;
  btn.textContent = '分析中...';
  setStatus(`正在分析 ${ticker}，這可能需要 1-2 分鐘，請勿關閉頁面…`, 'running');
  document.getElementById('out').textContent='分析中...';

  try{
    const r = await fetch('/api/analyze',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ticker,date})
    });
    const j = await r.json();
    document.getElementById('out').textContent = JSON.stringify(j,null,2);
    if(j.error){
      setStatus(`分析失敗：${j.error}`, 'error');
      return;
    }

    setKPIs(j?.fetched?.finnhub_summary?.quote, j?.fetched?.finnhub_summary?.price_target, j?.analysis?.action?.rating);
    renderTimeline(j?.analysis?.per_filing);
    renderConclusion(j?.analysis);
    setStatus('分析完成 ✅', 'done');
  }catch(err){
    setStatus(`連線失敗：${err.message}`, 'error');
  }finally{
    btn.disabled = false;
    btn.textContent = prevLabel;
  }
}

document.getElementById('go').addEventListener('click', analyze);
</script>
</body>
</html>
