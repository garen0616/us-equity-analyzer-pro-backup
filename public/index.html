<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>美股財報分析 Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0e14;--card:#121826;--muted:#94a3b8;--text:#e2e8f0;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',sans-serif;color:var(--text);padding-bottom:90px}
.wrap{max-width:1200px;margin:40px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h1{font-size:28px;margin:0 0 12px}
label{display:block;margin:8px 0 6px;color:var(--muted)}
input,button,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0f172a;color:var(--text);font-size:16px}
input[type="date"]{-webkit-appearance:none;color:var(--text);}
input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1);}
option{background:#0f172a;color:var(--text);}
button{cursor:pointer;background:linear-gradient(135deg,#2563eb,#06b6d4);border:none}
button:disabled{opacity:.6;cursor:not-allowed}
.row{display:grid;grid-template-columns:repeat(3,1fr) 150px;gap:12px}
.muted{color:var(--muted)}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px}
.kpi{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:12px}
.kpi h3{margin:0;font-size:13px;color:var(--muted)}
.kpi p{margin:6px 0 0;font-size:20px;font-weight:700}
pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px;color:#cbd5e1}
canvas{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px}
.status-pill{margin-top:14px;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:#0f172a;border:1px solid #1f2937;font-size:14px;color:var(--muted)}
.status-pill::before{content:'';width:10px;height:10px;border-radius:50%;background:var(--muted)}
.status-pill[data-state="running"]{color:#bfdbfe;border-color:#2563eb}
.status-pill[data-state="running"]::before{background:#60a5fa;animation:pulse 1s ease-in-out infinite}
.status-pill[data-state="done"]{color:var(--ok);border-color:var(--ok)}
.status-pill[data-state="done"]::before{background:var(--ok);animation:none}
.status-pill[data-state="error"]{color:var(--bad);border-color:var(--bad)}
.status-pill[data-state="error"]::before{background:var(--bad)}
.status-pill[data-state="idle"]::before{background:var(--muted)}
.status-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;align-items:flex-start}
.ghost-btn{background:transparent;border:1px solid #334155;color:var(--muted);padding:8px 16px;border-radius:999px;font-size:14px;width:auto;display:none;margin-top:2px}
.ghost-btn:hover{border-color:#475569;color:#e2e8f0}
.batch-running{display:none;align-items:center;gap:8px;color:#bfdbfe;font-size:14px}
.batch-dot{width:12px;height:12px;border-radius:50%;background:#60a5fa;animation:pulse-ball .8s ease-in-out infinite}
.timeline{display:grid;gap:10px}
.ti{border:1px solid #1f2937;border-radius:12px;padding:12px;background:#0f172a}
.ti h4{margin:0 0 8px}
.ti .meta{font-size:13px;color:var(--muted)}
.summary{line-height:1.7}
@media(max-width:1000px){.grid,.row,.kpis{grid-template-columns:1fr}}
@keyframes pulse{0%{transform:scale(.7);opacity:.7}50%{transform:scale(1.3);opacity:1}100%{transform:scale(.7);opacity:.7}}
@keyframes pulse-ball{0%{transform:translateY(0)}50%{transform:translateY(-5px)}100%{transform:translateY(0)}}
</style>
</head>
<body>
<div class="wrap">
  <h1>美股財報分析 Pro</h1>
  <p class="muted">輸入股票代號與日期（YYYY-MM-DD）。系統回溯四季 10-Q/10-K，合併分析師資料，輸出五大指標與投資建議。</p>
  <div class="card">
    <div class="row">
      <div><label>Ticker</label><input id="t" value="NVDA" placeholder="NVDA"/></div>
      <div><label>Date</label><input id="d" type="date" value="2025-11-08"/></div>
      <div><label>模型</label>
        <select id="model">
          <option value="gpt-5" selected>gpt-5</option>
          <option value="gpt-4.1">gpt-4.1</option>
          <option value="gpt-4o-mini">gpt-4o-mini</option>
        </select>
      </div>
      <div style="align-self:end"><button id="go">分析</button></div>
      <div style="grid-column:1 / -1">
        <div class="status-row">
          <div id="status" class="status-pill" data-state="idle">待命中，請輸入條件後開始分析。</div>
          <button id="stop" class="ghost-btn">停止</button>
        </div>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi"><h3>現價</h3><p id="px">-</p></div>
      <div class="kpi"><h3>分析師平均/共識目標價</h3><p id="ptMean">-</p></div>
      <div class="kpi"><h3>ChatGPT 總結目標價</h3><p id="ptRange">-</p></div>
      <div class="kpi"><h3>建議</h3><p id="rating">-</p></div>
      <div class="kpi"><h3>類型</h3><p id="segment">-</p></div>
      <div class="kpi"><h3>個股體質分數</h3><p id="qualityScore">-</p></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">財報時間線與重點摘要</h3>
    <div id="timeline" class="timeline"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">ChatGPT 總結與結論</h3>
    <div id="consensus" class="summary muted">尚無資料</div>
    <div id="decision" class="summary" style="margin-top:8px"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">個股體質詳解</h3>
    <div id="profileSummary" class="summary muted">尚無資料</div>
    <div id="profileDetail" class="summary" style="margin-top:8px"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">批次分析</h3>
    <div class="summary muted" style="margin-bottom:12px">
      利用上方下方工作列上傳 Excel/CSV（第一欄 ticker、第二欄 date），系統會逐行呼叫分析、然後下載包含現價、分析師平均/共識目標價與 ChatGPT 目標價的 CSV。
    </div>
    <div class="summary muted">
      <strong>步驟：</strong><br/>
      1. 按「選擇 Excel」並選取檔案。<br/>
      2. 上傳後工作列會變成跑動球並顯示「批次分析中」。<br/>
      3. 完成後自動觸發下載，並可在 JSON 區查看完整結果。
    </div>
    <div class="batch-card-action" style="margin-top:12px;display:flex;gap:12px;align-items:center">
      <input type="file" id="batchFile" accept=".xlsx,.xls,.csv" hidden>
      <button id="batchCardBtn">選擇 Excel</button>
      <div id="batchRunning" class="batch-running">
        <div class="batch-dot"></div>
        <span>批次分析中，請稍後…</span>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">詳細 JSON（除錯用）</h3>
    <pre id="out">尚未查詢</pre>
  </div>
</div>

<script>
function clamp(x){ return Math.max(0, Math.min(1, x)); }
function n(x, d=2){ const v=Number(x); return Number.isFinite(v)? v.toFixed(d):'-'; }
function toNum(x){ const v=Number(x); return Number.isFinite(v)? v:null; }

function ensureTargets(pt, current){
  let hi = toNum(pt?.targetHigh), lo = toNum(pt?.targetLow), mean = toNum(pt?.targetMean ?? pt?.targetMedian);
  const cur = toNum(current);
  if(mean!=null){
    if(hi==null) hi = mean * 1.15;
    if(lo==null) lo = mean * 0.85;
  }
  if(hi!=null && lo==null) lo = hi/1.2;
  if(lo!=null && hi==null) hi = lo*1.2;
  if(cur!=null){
    if(hi!=null && cur>hi) hi = cur*1.05;
    if(lo!=null && cur<lo) lo = cur*0.95;
  }
  return {hi, lo, mean, cur};
}

function formatPriceMeta(meta){
  if(!meta?.value) return null;
  const map = {
    'finnhub_candle':'歷史收盤（Finnhub）',
    'alphavantage_daily':'歷史收盤（AlphaVantage）',
    'yahoo_chart':'歷史收盤（Yahoo）',
    'real-time':'即時價',
    'real-time_fallback':'即時價（備援）'
  };
  const label = map[meta.source] || (meta.kind === 'historical' ? '歷史收盤' : '即時價');
  const dateLabel = meta.as_of ? ` ${meta.as_of}` : '';
  return `${label}${dateLabel}`;
}

function formatSegment(profile){
  if(!profile) return '-';
  if(profile.segment_label) return profile.segment_label;
  const map = { large_cap:'大型股', small_cap:'小型股' };
  return map[profile.segment] || profile.segment || '-';
}

function formatScore(score){
  const num = toNum(score);
  return Number.isFinite(num) ? `${num.toFixed(0)}/100` : '-';
}

function setKPIs(quote, pt, priceMeta, action, profile){
  const last = toNum(priceMeta?.value ?? quote?.c);
  const targets = ensureTargets(pt, last);
  const priceLabel = last? ('$'+last.toFixed(2)) : '-';
  const metaLabel = formatPriceMeta(priceMeta);
  document.getElementById('px').textContent = metaLabel ? `${priceLabel}（${metaLabel}）` : priceLabel;
  document.getElementById('ptMean').textContent = targets.mean? ('$'+targets.mean.toFixed(2)) : '-';
  const llmTarget = toNum(action?.target_price);
  document.getElementById('ptRange').textContent = llmTarget? ('$'+llmTarget.toFixed(0)) : '-';
  const ratingRaw = typeof action?.rating==='string' ? action.rating : '';
  const ratingMap = { BUY:'買進', HOLD:'觀望', SELL:'賣出' };
  const ratingKey = ratingRaw.toUpperCase();
  const ratingDisplay = ratingMap[ratingKey] || ratingRaw || '-';
  document.getElementById('rating').textContent = ratingDisplay;
  document.getElementById('segment').textContent = formatSegment(profile);
  document.getElementById('qualityScore').textContent = formatScore(profile?.score);
}

function renderTimeline(perFiling){
  const box = document.getElementById('timeline');
  box.innerHTML='';
  (perFiling||[]).forEach((f,i)=>{
    const exp = f.explanation || '（模型目前未提供詳細解釋）';
    const html = `
      <div class="ti">
        <h4>${f.formLabel || f.form || 'Filing'} · <span class="meta">${f.filingDate || ''}</span></h4>
        <div class="meta">報告期間：${f.reportDate || '-'}</div>
        <div class="summary" style="margin-top:6px">${exp}</div>
      </div>
    `;
    box.insertAdjacentHTML('beforeend', html);
  });
}

function renderConclusion(analysis){
  const cons = analysis?.consensus_view?.summary || '（尚無共識摘要）';
  const act = analysis?.action || {};
  const dec = (act.rating? `<b>${act.rating}</b>`:'-') +
              (act.target_price? ` · 目標價 $${n(act.target_price,0)}`:'') +
              (act.stop_loss? ` · 止損 $${n(act.stop_loss,0)}`:'');
  document.getElementById('consensus').innerHTML = cons;
  document.getElementById('decision').innerHTML = dec + (act.rationale? `<div class="muted" style="margin-top:6px">${act.rationale}</div>`:'');
}

function renderProfile(profile){
  const summaryEl = document.getElementById('profileSummary');
  const detailEl = document.getElementById('profileDetail');
  if(!profile){
    summaryEl.textContent = '尚無資料';
    detailEl.textContent = '';
    return;
  }
  const filtersMet = profile.filters?.met ?? profile.filters_met;
  const filtersTotal = profile.filters?.total ?? profile.filters_total;
  const filterLine = (filtersMet!=null && filtersTotal!=null)
    ? `硬性條件：${filtersMet}/${filtersTotal} 項通過`
    : '';
  const scoreLine = Number.isFinite(toNum(profile.score))
    ? `體質評分：${formatScore(profile.score)}`
    : '';
  const segmentLine = formatSegment(profile);
  const headline = [segmentLine, filterLine, scoreLine].filter(Boolean).join(' ｜ ');
  const summaryText = profile.summary || profile.score_summary || profile.notes || '（模型尚未提供詳解）';
  summaryEl.innerHTML = `${headline? `<strong>${headline}</strong><br/>`:''}${summaryText}`;

  const details = [];
  const filterItems = profile.filters?.items || profile.filter_details;
  if(Array.isArray(filterItems) && filterItems.length){
    const list = filterItems.map(item=>{
      const passed = item.met ?? item.pass ?? false;
      const tag = passed ? '✅' : '⚠️';
      return `${tag} ${item.name || item.label || '條件'}：${item.reason || item.detail || ''}`;
    }).join('<br/>');
    details.push(`<div><strong>硬性過濾</strong><br/>${list}</div>`);
  }
  const scoreDetails = profile.score_detail || profile.score_breakdown;
  if(Array.isArray(scoreDetails) && scoreDetails.length){
    const list = scoreDetails.map(item=>{
      const pts = toNum(item.points ?? item.score);
      const ptsLabel = Number.isFinite(pts)? `${pts.toFixed(0)}分` : '';
      return `• ${(item.category || item.name || '').trim()} ${ptsLabel? `(${ptsLabel})`:''}：${item.reason || item.note || ''}`;
    }).join('<br/>');
    details.push(`<div style="margin-top:8px"><strong>打分拆解</strong><br/>${list}</div>`);
  }
  const catalysts = profile.catalysts;
  if(Array.isArray(catalysts) && catalysts.length){
    const list = catalysts.map(c=>`• ${c}`).join('<br/>');
    details.push(`<div style="margin-top:8px"><strong>催化重點</strong><br/>${list}</div>`);
  }
  detailEl.innerHTML = details.join('<br/><br/>');
}

const statusEl = document.getElementById('status');
const goBtn = document.getElementById('go');
const stopBtn = document.getElementById('stop');
const modelSelect = document.getElementById('model');
const defaultModel = modelSelect?.value || 'gpt-5';
const analyzeLabel = goBtn?.textContent || '分析';
let inFlightController = null;
let userAborted = false;

function setStatus(text, state='idle'){
  statusEl.textContent = text;
  statusEl.setAttribute('data-state', state);
}

function setAnalyzeRunning(running){
  if(!goBtn) return;
  if(running){
    goBtn.disabled = true;
    goBtn.textContent = '分析中...';
    if(stopBtn){
      stopBtn.style.display = 'inline-flex';
      stopBtn.disabled = false;
    }
  }else{
    goBtn.disabled = false;
    goBtn.textContent = analyzeLabel;
    if(stopBtn){
      stopBtn.style.display = 'none';
      stopBtn.disabled = false;
    }
    inFlightController = null;
  }
  if(modelSelect){
    modelSelect.disabled = running;
  }
}

async function analyze(){
  if(inFlightController){
    setStatus('已有分析任務執行中，請稍候或按「停止」。', 'running');
    return;
  }
  const ticker = document.getElementById('t').value.trim().toUpperCase();
  const date   = document.getElementById('d').value.trim();
  const model  = (modelSelect?.value || defaultModel).trim() || defaultModel;
  if(!ticker || !date){
    setStatus('請先輸入 Ticker 與 Date。', 'error');
    return;
  }

  userAborted = false;
  setAnalyzeRunning(true);
  setStatus(`正在分析 ${ticker}（模型 ${model}），這可能需要 1-2 分鐘，請勿關閉頁面…`, 'running');
  document.getElementById('out').textContent='分析中...';

  const controller = new AbortController();
  inFlightController = controller;

  try{
    const r = await fetch('/api/analyze',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ticker,date,model}),
      signal: controller.signal
    });
    const j = await r.json();
    document.getElementById('out').textContent = JSON.stringify(j,null,2);
    if(j.error){
      setStatus(`分析失敗：${j.error}`, 'error');
      return;
    }

    setKPIs(
      j?.fetched?.finnhub_summary?.quote,
      j?.fetched?.finnhub_summary?.price_target,
      j?.fetched?.finnhub_summary?.price_meta,
      j?.analysis?.action,
      j?.analysis?.profile
    );
    const filingsMeta = j?.fetched?.filings || [];
    const timelineData = (j?.analysis?.per_filing || []).map((f,i)=>{
      const meta = filingsMeta[i] || {};
      return {
        ...f,
        formLabel: f.formLabel || f.form_label || meta.form_label || meta.form || f.form
      };
    });
    renderTimeline(timelineData);
    renderConclusion(j?.analysis);
    renderProfile(j?.analysis?.profile);
    setStatus('分析完成 ✅', 'done');
  }catch(err){
    if(err.name === 'AbortError'){
      const msg = userAborted ? '用戶終止，請重新開始分析。' : '分析已中止，請稍後再試。';
      setStatus(msg, 'error');
      document.getElementById('out').textContent = '此次分析已被終止。';
    }else{
      setStatus(`連線失敗：${err.message}`, 'error');
    }
  }finally{
    setAnalyzeRunning(false);
  }
}

goBtn.addEventListener('click', analyze);
if(stopBtn){
  stopBtn.addEventListener('click', ()=>{
    if(!inFlightController) return;
    userAborted = true;
    stopBtn.disabled = true;
    inFlightController.abort();
  });
}

const batchFile = document.getElementById('batchFile');
const batchCardBtn = document.getElementById('batchCardBtn');
const batchRunning = document.getElementById('batchRunning');

function setBatchState(running){
  if(!batchCardBtn || !batchRunning) return;
  if(running){
    batchCardBtn.style.display = 'none';
    batchRunning.style.display = 'flex';
  }else{
    batchCardBtn.style.display = 'inline-flex';
    batchRunning.style.display = 'none';
  }
}
setBatchState(false);

async function handleBatchUpload(file){
  setBatchState(true);
  try{
    const fd = new FormData();
    fd.append('file', file);
    const res = await fetch('/api/batch',{ method:'POST', body: fd });
    if(!res.ok){
      const text = await res.text();
      throw new Error(text || '批次分析失敗');
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const base = file.name.replace(/\.[^.]+$/, '') || 'batch_results';
    const a = document.createElement('a');
    a.href = url;
    a.download = `${base}_results.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }catch(err){
    alert(`批次分析失敗：${err.message}`);
  }finally{
    setBatchState(false);
  }
}

if(batchCardBtn) batchCardBtn.addEventListener('click', ()=> batchFile.click());
batchFile.addEventListener('change', ()=>{
  const file = batchFile.files[0];
  if(file) handleBatchUpload(file);
  batchFile.value = '';
});
</script>
</body>
</html>
